let getTimetable=(()=>{var a=_asyncToGenerator(function*(){for(let b in mHbMax=0,pHbMax=0,timetable=yield $.post("post/v1/studentTimeTable",{year:year,quarter:quarter,studentID:studentID}),timetable.hybrid)"M"===timetable.hybrid[b].subject?mHbMax+=3:pHbMax+=3;getHistory(),fillButton()});return function(){return a.apply(this,arguments)}})(),getHistory=(()=>{var a=_asyncToGenerator(function*(){mHbFound=0,pHbFound=0,$("#absentTableBody").empty(),$("#presentTableBody").empty();let b=$("#absentDate").data("DateTimePicker").date(),c=moment(0),d=moment(0);c.year(b.year()).month(b.month()-3).date(b.date()),d.year(b.year()).month(b.month()+3).date(b.date());let e=yield $.post("post/v1/listAttendance",{studentID:studentID,studentStartDate:c.valueOf(),studentEndDate:d.valueOf()}),f=[];for(let h in e)0===e[h].courseID?f.push($.post("post/v1/studentHybridSubject",{studentID:studentID,hybridID:e[h].hybridID})):f.push(courseInfo(e[h].courseID));let g=yield Promise.all(f);for(let h=0;h<e.length;h++){let j=moment(e[h].date).format("DD/MM/YY - HH:mm"),k;1===e[h].type?(k=$("#absentTableBody"),0===e[h].courseID?(k.append("<tr><td class='text-center'>"+j+"</td><td class='text-center'>FHB:"+g[h].subject+"</td><td class='text-center'>"+e[h].sender+"</td></tr>"),"M"===g[h].subject?mHbFound+=1:"P"===g[h].subject&&(pHbFound+=1)):k.append("<tr><td class='text-center'>"+j+"</td><td class='text-center'>CR:"+g[h].courseName+"</td><td class='text-center'>"+e[h].sender+"</td></tr>")):(k=$("#presentTableBody"),0===e[h].courseID&&(k.append("<tr><td class='text-center'>"+j+"</td><td class='text-center'>FHB:"+e[h].subject+"</td><td class='text-center'>"+e[h].sender+"</td></tr>"),"M"===e[h].subject?mHbFound-=1:"P"===e[h].subject&&(pHbFound-=1)))}editQuota()});return function(){return a.apply(this,arguments)}})(),sendData=(()=>{var a=_asyncToGenerator(function*(){$("#loadingModal").modal("show");let b=$("#absentDate").data("DateTimePicker").date(),c=moment(0);c.year(b.year()).month(b.month()).date(b.date());let d="\n",e=yield name(studentID);d=d+e.nickname+" "+e.firstname+"\n",d=d+"\u0E15\u0E49\u0E2D\u0E07\u0E01\u0E32\u0E23\u0E25\u0E32: "+b.format("ddd DD/MM/YY")+"\n";let f=[];for(let j,h=0;h<$(".btn-warning").length;h++)j=$($(".btn-warning")[h]),d=0===b.day()||6===b.day()?d+j.html()+" - "+classHour(j)+":00\n":d+j.html()+" - 17:00\n",j.hasClass("cr")?f.push($.post("post/v1/addStudentAbsent",{userID:studentID,date:c.hour(classHour(j)).valueOf(),courseID:j.attr("id"),reason:$("#reasonInput").val()+" "+$("#reasonOptionInput").val(),sender:$("#senderInput").val()})):0===b.day()||6===b.day()?f.push($.post("post/v1/addStudentAbsent",{userID:studentID,date:c.hour(classHour(j)).valueOf(),hybridID:j.attr("id"),reason:$("#reasonInput").val()+" "+$("#reasonOptionInput").val(),sender:$("#senderInput").val()})):f.push($.post("post/v1/addStudentAbsent",{userID:studentID,date:c.hour(17).valueOf(),hybridID:j.attr("id"),reason:$("#reasonInput").val()+" "+$("#reasonOptionInput").val(),sender:$("#senderInput").val()}));d=d+"\u0E40\u0E2B\u0E15\u0E38\u0E1C\u0E25:"+$("#reasonInput").val()+" "+$("#reasonOptionInput").val();let g=yield Promise.all(f);if("\u0E25\u0E32\u0E01\u0E34\u0E08"!==$("#reasonInput").val()){let h=$("#customFile").get(0).files[0],j=new FormData;j.append("files",h,h.name),j.append("attendanceID",g),$.ajax({url:"post/v1/uploadAttendanceDocument",type:"POST",data:j,processData:!1,contentType:!1,success:function(){lineNotify("MonkeyAdmin",d).then(()=>{location.reload()}),log("upload")}})}else yield lineNotify("MonkeyAdmin",d),location.reload()});return function(){return a.apply(this,arguments)}})();function _asyncToGenerator(a){return function(){var b=a.apply(this,arguments);return new Promise(function(c,d){function e(f,g){try{var h=b[f](g),j=h.value}catch(k){return void d(k)}return h.done?void c(j):Promise.resolve(j).then(function(k){e("next",k)},function(k){e("throw",k)})}return e("next")})}}let studentID,year,quarter,timetable,mHbMax,pHbMax,mHbFound,pHbFound,startDate=moment();startDate.date(startDate.date()-1),$("#absentDate").datetimepicker({format:"DD/MM/YYYY",daysOfWeekDisabled:[1,3,5],minDate:startDate});let cookies=getCookieDict();studentID=cookies.monkeyWebUser,getYearAndQuarter();function getYearAndQuarter(){getConfig().then(a=>{year=a.defaultQuarter.quarter.year,quarter=a.defaultQuarter.quarter.quarter,genBanner(),getTimetable()})}function genBanner(){$("#pageBanner").html("CR"+(year+543+"").slice(2)+"Q"+quarter)}function fillButton(){$(".selector").html("-").removeClass("cr hb btn-warning").addClass("btn-light disabled"),$(".labelor").html("-");let a=$("#absentDate").data("DateTimePicker").date(),b=timetable.course,c=timetable.hybrid;if(2===a.day()||4===a.day())for(let d in $(".label-8").html("17-19"),c){let e=moment(c[d].day);e.day()===a.day()&&$(".btn-8").html("FHB:"+c[d].subject).removeClass("disabled").addClass("hb").attr("id",c[d].hybridID)}else{for(let d in $(".label-8").html("8-10"),$(".label-10").html("10-12"),$(".label-13").html("13-15"),$(".label-15").html("15-17"),b){let e=moment(b[d].day);e.day()===a.day()&&$(".btn-"+e.hour()).html("CR:"+b[d].courseName).removeClass("disabled").addClass("cr").attr("id",b[d].courseID)}for(let d in c){let e=moment(c[d].day);e.day()===a.day()&&$(".btn-"+e.hour()).html("FHB:"+c[d].subject).removeClass("disabled").addClass("hb").attr("id",c[d].hybridID)}}}function editQuota(){$("#mQuota").html("\u0E42\u0E04\u0E27\u0E15\u0E49\u0E32\u0E25\u0E32 FHB:M "+(mHbMax-mHbFound)+"/"+mHbMax),$("#pQuota").html("\u0E42\u0E04\u0E27\u0E15\u0E49\u0E32\u0E25\u0E32 FHB:P "+(pHbMax-pHbFound)+"/"+pHbMax)}$("#absentDate").on("dp.change",function(){fillButton(),getHistory()}),$(".selector").click(function(){$(this).hasClass("disabled")||$(this).toggleClass("btn-light btn-warning")});const checkEmer=()=>{let a=!1,b=86400000,c=moment();c.hour(18).minute(0).second(0).millisecond(0);let d=$("#absentDate").data("DateTimePicker").date();return d.hour(18).minute(0).second(0).millisecond(0),0===d.day()?d.valueOf()-c.valueOf()<2*b&&(a=!0):d.valueOf()-c.valueOf()<b&&(a=!0),a};$("#reasonInput").change(function(){"\u0E25\u0E32\u0E01\u0E34\u0E08"===$("#reasonInput").val()?$(".custom-file").hide():$(".custom-file").show()}),$("#customFile").change(function(){let a=this.value,b;if(a){let c=0<=a.indexOf("\\")?a.lastIndexOf("\\"):a.lastIndexOf("/");b=a.slice(c+1)}$(".custom-file-label").html(b)}),$("#submitButt").click(function(){let a=0,b=0;if(0>=$(".btn-warning").length)alert("\u0E01\u0E23\u0E38\u0E13\u0E32\u0E40\u0E25\u0E37\u0E2D\u0E01\u0E2D\u0E22\u0E48\u0E32\u0E07\u0E19\u0E49\u0E2D\u0E22 1 \u0E27\u0E34\u0E0A\u0E32");else{for(let d,c=0;c<$(".btn-warning").length;c++)d=$($(".btn-warning")[c]),"FHB:M"===d.html()?a+=1:"FHB:P"===d.html()&&(b+=1);if(a+mHbFound>mHbMax)alert("\u0E42\u0E04\u0E27\u0E15\u0E49\u0E32\u0E25\u0E32 FHB:M \u0E44\u0E21\u0E48\u0E40\u0E1E\u0E35\u0E22\u0E07\u0E1E\u0E2D");else if(b+pHbFound>pHbMax)alert("\u0E42\u0E04\u0E27\u0E15\u0E49\u0E32\u0E25\u0E32 FHB:P \u0E44\u0E21\u0E48\u0E40\u0E1E\u0E35\u0E22\u0E07\u0E1E\u0E2D");else if("\u0E25\u0E32\u0E01\u0E34\u0E08"!==$("#reasonInput").val()){if($("#customFile").val()){let c=$("#customFile"),d=c.val().split(".").pop().toLowerCase();if(-1===$.inArray(d,["png","jpg","jpeg"]))alert("\u0E01\u0E23\u0E38\u0E13\u0E32\u0E2D\u0E31\u0E1E\u0E44\u0E1F\u0E25\u0E4C .jpg, .jpeg \u0E2B\u0E23\u0E37\u0E2D .png \u0E40\u0E17\u0E48\u0E32\u0E19\u0E31\u0E49\u0E19");else if(""===$("#senderInput").val())alert("\u0E01\u0E23\u0E38\u0E13\u0E32\u0E43\u0E2A\u0E48\u0E1C\u0E39\u0E49\u0E41\u0E08\u0E49\u0E07");else{let e="\u0E22\u0E37\u0E19\u0E22\u0E31\u0E19\u0E01\u0E32\u0E23\u0E25\u0E32?";checkEmer()&&(e="\u0E22\u0E37\u0E19\u0E22\u0E31\u0E19\u0E01\u0E32\u0E23\u0E25\u0E32\u0E09\u0E38\u0E01\u0E40\u0E09\u0E34\u0E19?"),confirm(e)&&sendData()}}else alert("\u0E01\u0E23\u0E38\u0E13\u0E32\u0E2D\u0E31\u0E1E\u0E42\u0E2B\u0E25\u0E14\u0E2B\u0E25\u0E31\u0E01\u0E10\u0E32\u0E19\u0E01\u0E32\u0E23\u0E25\u0E32");}else if(""===$("#senderInput").val())alert("\u0E01\u0E23\u0E38\u0E13\u0E32\u0E43\u0E2A\u0E48\u0E1C\u0E39\u0E49\u0E41\u0E08\u0E49\u0E07");else{let c="\u0E22\u0E37\u0E19\u0E22\u0E31\u0E19\u0E01\u0E32\u0E23\u0E25\u0E32?";checkEmer()&&(c="\u0E22\u0E37\u0E19\u0E22\u0E31\u0E19\u0E01\u0E32\u0E23\u0E25\u0E32\u0E09\u0E38\u0E01\u0E40\u0E09\u0E34\u0E19?"),confirm(c)&&sendData()}}});const classHour=a=>{let b=0;return a.hasClass("btn-8")?b=8:a.hasClass("btn-10")?b=10:a.hasClass("btn-13")?b=13:a.hasClass("btn-15")&&(b=15),b};